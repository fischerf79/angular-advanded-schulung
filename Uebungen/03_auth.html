<!DOCTYPE html>
    <html>
    <head>
        <meta http-equiv="Content-type" content="text/html;charset=UTF-8">
        <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/KaTeX/0.9.0/katex.min.css" integrity="sha384-TEMocfGvRuD1rIAacqrknm5BQZ7W7uWitoih+jMNFXQIbNl16bO8OZmylH/Vi/Ei" crossorigin="anonymous">
        <style>
/*--------------------------------------------------------------------------------------------- * Copyright (c) Microsoft Corporation. All rights reserved. * Licensed under the MIT License. See License.txt in the project root for license information. *--------------------------------------------------------------------------------------------*/ body { font-family: "Segoe WPC", "Segoe UI", "SFUIText-Light", "HelveticaNeue-Light", sans-serif, "Droid Sans Fallback"; font-size: 14px; padding: 0 12px; line-height: 22px; word-wrap: break-word; } body.scrollBeyondLastLine { margin-bottom: calc(100vh - 22px); } body.showEditorSelection .code-line { position: relative; } body.showEditorSelection .code-active-line:before, body.showEditorSelection .code-line:hover:before { content: ""; display: block; position: absolute; top: 0; left: -12px; height: 100%; } body.showEditorSelection li.code-active-line:before, body.showEditorSelection li.code-line:hover:before { left: -30px; } .vscode-light.showEditorSelection .code-active-line:before { border-left: 3px solid rgba(0, 0, 0, 0.15); } .vscode-light.showEditorSelection .code-line:hover:before { border-left: 3px solid rgba(0, 0, 0, 0.40); } .vscode-dark.showEditorSelection .code-active-line:before { border-left: 3px solid rgba(255, 255, 255, 0.4); } .vscode-dark.showEditorSelection .code-line:hover:before { border-left: 3px solid rgba(255, 255, 255, 0.60); } .vscode-high-contrast.showEditorSelection .code-active-line:before { border-left: 3px solid rgba(255, 160, 0, 0.7); } .vscode-high-contrast.showEditorSelection .code-line:hover:before { border-left: 3px solid rgba(255, 160, 0, 1); } img { max-width: 100%; max-height: 100%; } a { color: #4080D0; text-decoration: none; } a:focus, input:focus, select:focus, textarea:focus { outline: 1px solid -webkit-focus-ring-color; outline-offset: -1px; } hr { border: 0; height: 2px; border-bottom: 2px solid; } h1 { padding-bottom: 0.3em; line-height: 1.2; border-bottom-width: 1px; border-bottom-style: solid; } h1, h2, h3 { font-weight: normal; } h1 code, h2 code, h3 code, h4 code, h5 code, h6 code { font-size: inherit; line-height: auto; } a:hover { color: #4080D0; text-decoration: underline; } table { border-collapse: collapse; } table > thead > tr > th { text-align: left; border-bottom: 1px solid; } table > thead > tr > th, table > thead > tr > td, table > tbody > tr > th, table > tbody > tr > td { padding: 5px 10px; } table > tbody > tr + tr > td { border-top: 1px solid; } blockquote { margin: 0 7px 0 5px; padding: 0 16px 0 10px; border-left: 5px solid; } code { font-family: Menlo, Monaco, Consolas, "Droid Sans Mono", "Courier New", monospace, "Droid Sans Fallback"; font-size: 14px; line-height: 19px; } body.wordWrap pre { white-space: pre-wrap; } .mac code { font-size: 12px; line-height: 18px; } code > div { padding: 16px; border-radius: 3px; overflow: auto; } /** Theming */ .vscode-light { color: rgb(30, 30, 30); } .vscode-dark { color: #DDD; } .vscode-high-contrast { color: white; } .vscode-light code { color: #A31515; } .vscode-dark code { color: #D7BA7D; } .vscode-light code > div { background-color: rgba(220, 220, 220, 0.4); } .vscode-dark code > div { background-color: rgba(10, 10, 10, 0.4); } .vscode-high-contrast code > div { background-color: rgb(0, 0, 0); } .vscode-high-contrast h1 { border-color: rgb(0, 0, 0); } .vscode-light table > thead > tr > th { border-color: rgba(0, 0, 0, 0.69); } .vscode-dark table > thead > tr > th { border-color: rgba(255, 255, 255, 0.69); } .vscode-light h1, .vscode-light hr, .vscode-light table > tbody > tr + tr > td { border-color: rgba(0, 0, 0, 0.18); } .vscode-dark h1, .vscode-dark hr, .vscode-dark table > tbody > tr + tr > td { border-color: rgba(255, 255, 255, 0.18); } .vscode-light blockquote, .vscode-dark blockquote { background: rgba(127, 127, 127, 0.1); border-color: rgba(0, 122, 204, 0.5); } .vscode-high-contrast blockquote { background: transparent; border-color: #fff; }
</style>
<style>
/* Tomorrow Theme */ /* http://jmblog.github.com/color-themes-for-google-code-highlightjs */ /* Original theme - https://github.com/chriskempson/tomorrow-theme */ /* Tomorrow Comment */ .hljs-comment, .hljs-quote { color: #8e908c; } /* Tomorrow Red */ .hljs-variable, .hljs-template-variable, .hljs-tag, .hljs-name, .hljs-selector-id, .hljs-selector-class, .hljs-regexp, .hljs-deletion { color: #c82829; } /* Tomorrow Orange */ .hljs-number, .hljs-built_in, .hljs-builtin-name, .hljs-literal, .hljs-type, .hljs-params, .hljs-meta, .hljs-link { color: #f5871f; } /* Tomorrow Yellow */ .hljs-attribute { color: #eab700; } /* Tomorrow Green */ .hljs-string, .hljs-symbol, .hljs-bullet, .hljs-addition { color: #718c00; } /* Tomorrow Blue */ .hljs-title, .hljs-section { color: #4271ae; } /* Tomorrow Purple */ .hljs-keyword, .hljs-selector-tag { color: #8959a8; } .hljs { display: block; overflow-x: auto; color: #4d4d4c; padding: 0.5em; } .hljs-emphasis { font-style: italic; } .hljs-strong { font-weight: bold; }
</style>
<style>
ul.contains-task-list { padding-left: 0; } ul ul.contains-task-list { padding-left: 40px; } .task-list-item { list-style-type: none; } .task-list-item-checkbox { vertical-align: middle; }
</style>
        <style>
            body {
                font-family: -apple-system, BlinkMacSystemFont, 'Segoe WPC', 'Segoe UI', 'HelveticaNeue-Light', 'Ubuntu', 'Droid Sans', sans-serif;
                font-size: 14px;
                line-height: 1.6;
            }
        </style>
    </head>
    <body>
        <h1 id="angular-workshop--oauth-2-and-oidc">Angular Workshop: OAuth 2 and OIDC</h1>
<ul>
<li><a href="#angular-workshop--oauth-2-and-oidc">Angular Workshop: OAuth 2 and OIDC</a>
<ul>
<li><a href="#authentication">Authentication</a></li>
<li><a href="#authorization-for-the-web-api">Authorization for the Web API</a></li>
<li><a href="#bonus--token-refresh">Bonus: Token Refresh **</a></li>
</ul>
</li>
</ul>
<h2 id="authentication">Authentication</h2>
<p>In this part of the exercise you will use the library <code>angular-oauth2-oidc</code> to authenticate against an cloud-based authorization server.</p>
<ol>
<li>
<p>Open your <code>package.json</code> and notice that the package <code>angular-oauth2-oidc</code> has been installed.</p>
</li>
<li>
<p>Import the <code>OAuthModule</code> into your <code>AppModule</code> using the method <code>forRoot</code>.</p>
 <details>
 <summary>Show code</summary>
 <p>
<pre class="hljs"><code><div><span class="hljs-comment">// apps/flight-app/src/app/app.module.ts</span>

<span class="hljs-keyword">import</span> { OAuthModule } from <span class="hljs-string">'angular-oauth2-oidc'</span>;

[...]

@NgModule({
imports: [
    BrowserModule,
    HttpClientModule,

    OAuthModule.forRoot(),

    [...]
],
[...]
})
<span class="hljs-keyword">export</span> <span class="hljs-keyword">class</span> AppModule { }
</div></code></pre>
 </p>
 </details>
</li>
<li>
<p>Create a configuration file <code>auth.config.ts</code>:</p>
<pre class="hljs"><code><div><span class="hljs-comment">// apps/flight-app/src/app/auth.config.ts</span>

<span class="hljs-keyword">import</span> { AuthConfig } from <span class="hljs-string">'angular-oauth2-oidc'</span>;

<span class="hljs-keyword">export</span> <span class="hljs-keyword">const</span> authConfig: AuthConfig = {
    issuer: <span class="hljs-string">'https://steyer-identity-server.azurewebsites.net/identity'</span>,
    redirectUri: <span class="hljs-built_in">window</span>.location.origin + <span class="hljs-string">'/index.html'</span>,
    clientId: <span class="hljs-string">'spa-demo'</span>,
    scope: <span class="hljs-string">'openid profile email voucher'</span>
}
</div></code></pre>
</li>
<li>
<p>Inject the <code>OAuthService</code> into your <code>AppComponent</code> and configure it.</p>
<pre class="hljs"><code><div><span class="hljs-comment">// apps/flight-app/src/app/app.component.ts</span>

@Component({[...]})
<span class="hljs-keyword">export</span> <span class="hljs-keyword">class</span> AppComponent  {
    <span class="hljs-keyword">constructor</span>([...] private oauthService: OAuthService) {
        [...]

        <span class="hljs-keyword">this</span>.oauthService.configure(authConfig);
        <span class="hljs-keyword">this</span>.oauthService.tokenValidationHandler = <span class="hljs-keyword">new</span> JwksValidationHandler();
        <span class="hljs-keyword">this</span>.oauthService.loadDiscoveryDocumentAndTryLogin();
    }
}
</div></code></pre>
</li>
<li>
<p>If you have written an <code>AuthService</code> in another exercise, update it so that it uses the <code>OAuthService</code>.
Otherwise, create a new <code>AuthService</code> in the <code>shared/auth</code> folder:</p>
<pre class="hljs"><code><div><span class="hljs-comment">// apps/flight-app/src/app/shared/auth/services/auth.service.ts</span>

<span class="hljs-keyword">import</span> { OAuthService } from <span class="hljs-string">'angular-oauth2-oidc'</span>;
<span class="hljs-keyword">import</span> { Injectable } from <span class="hljs-string">'@angular/core'</span>;

@Injectable({
    providedIn: <span class="hljs-string">'root'</span>
})
<span class="hljs-keyword">export</span> <span class="hljs-keyword">class</span> AuthService {

    <span class="hljs-keyword">constructor</span>(private oauthService: OAuthService) {
    }
    
    <span class="hljs-keyword">get</span> userName(): <span class="hljs-built_in">string</span> {
        <span class="hljs-keyword">let</span> claims = <span class="hljs-keyword">this</span>.oauthService.getIdentityClaims();
        <span class="hljs-keyword">return</span> claims ? claims[<span class="hljs-string">'given_name'</span>] : <span class="hljs-literal">null</span>;
    }

    login() {
        <span class="hljs-keyword">this</span>.oauthService.initImplicitFlow();
    }

    logout() {
        <span class="hljs-keyword">this</span>.oauthService.logOut();
    }
    
}
</div></code></pre>
</li>
<li>
<p>Inject the <code>AuthService</code> into your <code>HomeComponent</code> and use it to greet the user with his first name.
Also provide buttons for logging in and out. These should delegate to the <code>AuthService</code>.</p>
 <details>
 <summary>Show code</summary>
 <p>
<pre class="hljs"><code><div><span class="hljs-comment">// apps/flight-app/src/app/home/home.component.ts</span>

@Component({ [...] })
<span class="hljs-keyword">export</span> <span class="hljs-keyword">class</span> HomeComponent {

    <span class="hljs-keyword">constructor</span>([...] private authService: AuthService) { }

    [...]

    <span class="hljs-keyword">get</span> userName(): <span class="hljs-built_in">string</span> {
        <span class="hljs-keyword">return</span> <span class="hljs-keyword">this</span>.authService.userName;
    }

    login(): <span class="hljs-built_in">void</span> {
        <span class="hljs-keyword">this</span>.authService.login();
    }

    logout(): <span class="hljs-built_in">void</span> {
        <span class="hljs-keyword">this</span>.authService.logout();
    }

}
</div></code></pre>
 </p>
 </details>
 <details>
 <summary>Show code (HTML)</summary>
 <p>
<pre class="hljs"><code><div>// apps/flight-app/src/app/home/home.component.html

<span class="hljs-tag">&lt;<span class="hljs-name">h1</span> *<span class="hljs-attr">ngIf</span>=<span class="hljs-string">"userName"</span>&gt;</span>Welcome, {{userName}}!<span class="hljs-tag">&lt;/<span class="hljs-name">h1</span>&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">h1</span> *<span class="hljs-attr">ngIf</span>=<span class="hljs-string">"!userName"</span>&gt;</span>Welcome!<span class="hljs-tag">&lt;/<span class="hljs-name">h1</span>&gt;</span>

<span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"card"</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"content"</span>&gt;</span>
      <span class="hljs-tag">&lt;<span class="hljs-name">button</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"btn btn-default"</span> (<span class="hljs-attr">click</span>)=<span class="hljs-string">"login()"</span>&gt;</span>Login<span class="hljs-tag">&lt;/<span class="hljs-name">button</span>&gt;</span>
      <span class="hljs-tag">&lt;<span class="hljs-name">button</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"btn btn-default"</span> (<span class="hljs-attr">click</span>)=<span class="hljs-string">"logout()"</span>&gt;</span>Logout<span class="hljs-tag">&lt;/<span class="hljs-name">button</span>&gt;</span>
    <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
</div></code></pre>
 </p>
 </details>
</li>
<li>
<p>Test your solution. You can log in with user:<code>max</code> and pass:<code>geheim</code>.</p>
</li>
</ol>
<h2 id="authorization-for-the-web-api">Authorization for the Web API</h2>
<p>In this part of the exercise you will use the received access token to call a secured web api.</p>
<ol start="9">
<li>
<p>Change your <code>FlightService</code> so that it accesses the <code>/secureflight/byRoute</code>.</p>
</li>
<li>
<p>Search for flights and find out that you receive the error code 401.</p>
</li>
<li>
<p>If you wrote an <code>AuthInterceptor</code> in an earlier exercise, update it so that it now sends the current access token.
If you do not have an interceptor, write one in the <code>shared/auth</code> folder.</p>
<details>
<summary>Show code</summary>
<p>
<pre class="hljs"><code><div><span class="hljs-comment">// apps/flight-app/src/app/shared/auth/services/auth-intercepter.service.ts</span>

<span class="hljs-keyword">import</span> { Injectable } from <span class="hljs-string">'@angular/core'</span>;
<span class="hljs-keyword">import</span> { OAuthService, OAuthStorage } from <span class="hljs-string">'angular-oauth2-oidc'</span>;
<span class="hljs-keyword">import</span> { HttpEvent, HttpHandler, HttpInterceptor, HttpRequest, HttpResponse, HttpErrorResponse } from <span class="hljs-string">'@angular/common/http'</span>;
<span class="hljs-keyword">import</span> {Observable} from <span class="hljs-string">'rxjs/Observable'</span>;

<span class="hljs-keyword">import</span> { catchError } from <span class="hljs-string">'rxjs/operators'</span>;
<span class="hljs-keyword">import</span> { _throw } from <span class="hljs-string">'rxjs/observable/throw'</span>;
<span class="hljs-keyword">import</span> { Router } from <span class="hljs-string">'@angular/router'</span>;

@Injectable()
<span class="hljs-keyword">export</span> <span class="hljs-keyword">class</span> AuthInterceptor <span class="hljs-keyword">implements</span> HttpInterceptor {
    
    <span class="hljs-keyword">constructor</span>(private storage: OAuthStorage, private router: Router) {
    }

    <span class="hljs-keyword">public</span> intercept(req: HttpRequest&lt;<span class="hljs-built_in">any</span>&gt;, next: HttpHandler): Observable&lt;HttpEvent&lt;<span class="hljs-built_in">any</span>&gt;&gt; {
        
        <span class="hljs-keyword">if</span> (req.url.startsWith(<span class="hljs-string">'http://www.angular.at'</span>)) {
            <span class="hljs-keyword">let</span> headers = req.headers
                            .set(<span class="hljs-string">'Authorization'</span>, 
                                    <span class="hljs-string">'Bearer '</span> + <span class="hljs-keyword">this</span>.storage.getItem(<span class="hljs-string">'access_token'</span>));

            req = req.clone({ headers });
        }
        
        <span class="hljs-keyword">return</span> next
                .handle(req)
                .pipe(
                    catchError(error =&gt; <span class="hljs-keyword">this</span>.handleError(error))
                );
    }

    <span class="hljs-keyword">private</span> handleError(event: HttpErrorResponse) {
        <span class="hljs-keyword">if</span> (event.status == <span class="hljs-number">401</span> || event.status == <span class="hljs-number">403</span>) {
        <span class="hljs-keyword">this</span>.router.navigate([<span class="hljs-string">'/home'</span>, {needsLogin: <span class="hljs-literal">true</span>}]);
        }
        <span class="hljs-keyword">return</span> _throw(event);
    }
}
</div></code></pre>
</p>
</details>
</li>
<li>
<p>Make sure that the <code>AuthInterceptor</code> is registered in the <code>SharedModule</code>:</p>
<pre class="hljs"><code><div><span class="hljs-comment">// apps/flight-app/src/app/shared/shared.module.ts</span>

@NgModule({ ... })
<span class="hljs-keyword">export</span> <span class="hljs-keyword">class</span> SharedModule {
    <span class="hljs-keyword">static</span> forRoot(): ModuleWithProviders {
        <span class="hljs-keyword">return</span> {
            ngModule: SharedModule,
            providers: [
                [...], <span class="hljs-comment">// keep existing providers ...</span>
                {
                    provide: HTTP_INTERCEPTORS,
                    useClass: AuthInterceptor,
                    multi: <span class="hljs-literal">true</span>
                }
            ]
        }
    }
}
</div></code></pre>
</li>
<li>
<p>Log in with user:<code>max</code> and pass:<code>geheim</code>.
Search again for flights. Now you should get data.</p>
</li>
<li>
<p>Trace the exchanged message using the network tab in the Dev Tools (F12) and notice that the access token is being sent in the Authorization header. Look into the received token using <a href="http://jwt.io">jwt.io</a>.</p>
</li>
</ol>
<h2 id="bonus--token-refresh">Bonus: Token Refresh **</h2>
<p>Have a look at the <a href="https://manfredsteyer.github.io/angular-oauth2-oidc/docs/additional-documentation/refreshing-a-token-(silent-refresh).html">documentation</a>. It shows how to make the library to automatically refresh a token before it expires. Implement this idea in your application.</p>
<p>To test it, you could temporarily set the config property timeoutFactor in your auth.config.ts to 0. This should make the library to refresh the token all the time. Use the network tab in your browser's Dev tools to assure your self that the token is refreshed.</p>

    </body>
    </html>